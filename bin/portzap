#!/bin/sh
set -e

#
# globals
#
localbase=$(realpath "$(dirname "$0")"/..)
libexec="${localbase}"/libexec/portzap
repodir="/home/_portzap/ports"
giturl="${PORTZAP_CLONEURL:-https://github.com/hardenedBSD/ports}"
installdir="${PORTZAP_INSTALLDIR:-/usr/ports}"
defaultbranch="hardenedbsd/main"
commitfile="${installdir}"/.portzap

#
# functions
#
. "${libexec}"/functions/print.sh

require_dependency()
{
    local dep
    for dep in "$@"; do
        if ! command -v "$dep" > /dev/null 2>&1; then
            printerr "${dep} wasn't found on \$PATH"
            exit 1
        fi
    done
}

print_usage()
{
    printf "Usage: portzap COMMAND [OPTIONS]\n"
    printf "\n"
    printf "Setup\n"
    printf "  setup       Setup portzap for the first time\n"
    printf "  teardown    Reverse the changes made by 'portzap setup'\n"
    printf "\n"
    printf "General\n"
    printf "  clone       Clone the hardenedBSD ports tree\n"
    printf "  pull        Pull ports tree updates\n"
    printf "  sh          Run /bin/sh within /home/_portzap/ports/\n"
    printf "  status      Show whether mac_do(4) rules are applied\n"
    printf "  apply       Apply mac_do(4) rules\n"
    printf "  unapply     Remove mac_do(4) rules\n"
    printf "  rm          Remove /usr/ports/ and /home/_portzap/ports/\n"
    printf "  install     Install the ports tree into /usr/ports/\n"
    printf "\n"
}

#
# main
#
while getopts "v" opt; do
    case "${opt}" in
        "v")
            cat "${localbase}"/share/portzap/VERSION
            exit 0
            ;;
        *)
            print_usage
            exit 1
            ;;
    esac
done

case $1 in
    "setup")
        shift
        "${libexec}"/commands/portzap-setup "${@}"
        ;;
    "teardown")
        shift
        "${libexec}"/commands/portzap-teardown "${@}"
        ;;
    "clone")
        shift
        require_dependency git mdo
        "${libexec}"/commands/portzap-clone "${giturl}" "${repodir}" "${defaultbranch}" "${@}"
        ;;
    "pull")
        shift
        require_dependency git mdo
        "${libexec}"/commands/portzap-pull "${repodir}" "${@}"
        ;;
    "sh")
        shift
        require_dependency mdo
        "${libexec}"/commands/portzap-sh "${repodir}" "${@}"
        ;;
    "status")
        shift
        "${libexec}"/commands/portzap-status "${@}"
        ;;
    "apply")
        shift
        "${libexec}"/commands/portzap-apply "${@}"
        ;;
    "unapply")
        shift
        "${libexec}"/commands/portzap-unapply "${@}"
        ;;
    "rm")
        shift
        "${libexec}"/commands/portzap-rm "${repodir}" "${installdir}" "${@}"
        ;;
    "install")
        shift
        require_dependency git mdo rsync
        "${libexec}"/commands/portzap-install "${repodir}" "${installdir}" "${commitfile}" "${@}"
        ;;
    *)
        print_usage
        exit 1
        ;;
esac
