#!/bin/sh
set -e

# Variables
rootdir=$(dirname "$0")
giturl="${PORTZAP_GITURL:-https://git.hardenedbsd.org/hardenedbsd/ports.git}"
gitdir="/home/_portzap/ports"
installdir="${PORTZAP_INSTALLDIR:-/usr/ports/}"
revision="${installdir}/.portzap"
libexec=$(realpath "${rootdir}/../libexec/portzap/")

# Masks
clone_mask=007
pull_mask=007

# Functions
. "$libexec/functions/portzap-install"
. "$libexec/functions/portzap-pull"
. "$libexec/functions/portzap-clone"
. "$libexec/functions/requirements"

case $1 in
    "clone")
        require_deps git
        require_group _portzap
        portzap_clone "$portzap_dir" "$giturl" "$clone_mask"
        ;;
    "pull")
        require_deps git
        require_group _portzap
        portzap_pull "$portzap_dir" "$pull_mask"
        ;;
    "install")
        require_root
        require_deps git
        portzap_install "$installdir" "$portzap_dir" "$libexec" "$portzap_file"
        ;;
    *)
        echo "Usage: portzap clone|pull|install"
        ;;
    esac
