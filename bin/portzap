#!/bin/sh -e

##
# variables
rootdir=$(dirname "$0")
gitdir="/home/_portzap/ports"
giturl="${PORTZAP_GITURL:-https://git.hardenedbsd.org/hardenedbsd/ports.git}"
branch="${PORTZAP_BRANCH:-hardenedbsd/main}"
installdir="${PORTZAP_INSTALLDIR:-/usr/ports}"
revision="${installdir}/.portzap"
libexec=$(realpath "${rootdir}/../libexec/portzap")

##
# functions
require_root() {
    if [ "$(id -u)" != "0" ]; then
        echo "This command requires root privileges."
        exit 1
    fi

}

require_membership_of() {
    group=$1
    if ! id -Gn | tr ' ' '\n' | grep -e "^${group}$" > /dev/null 2>&1; then
        echo "This command requires a user to be a member of ${group}."
        exit 1
    fi
}

require_dependency() {
    deps=$1
    for dep in $deps; do
        if ! which -s "$dep"; then
            echo "This command requires ${dep}, but it was not found."
            exit 1
        fi
    done
}

##
# main
i=1
while [ "${i}" -le "$#" ]; do
    eval "_portzap_option=\$${i}"
    # shellcheck disable=SC2154
    if [ "${_portzap_option}" = "-v" ]; then
        cat "${rootdir}"/../share/portzap/VERSION
        exit 0
    fi
    # shellcheck disable=SC2003
    i=$(expr "${i}" + 1);
done


case $1 in
    "clone")
        require_dependency "git doas"
        require_membership_of _portzap
        doas -u _portzap "${libexec}"/portzap-clone "${giturl}" "${gitdir}" "${branch}"
        ;;
    "pull")
        require_dependency "git doas"
        require_membership_of _portzap
        doas -u _portzap "${libexec}"/portzap-pull "${gitdir}" "${branch}"
        ;;
    "erase")
        require_membership_of _portzap
        doas -u _portzap "${libexec}"/portzap-erase "${gitdir}" "${installdir}"
        ;;
    "install")
        require_root
        require_dependency "git doas"
        "${libexec}"/portzap-install "${gitdir}" "${installdir}" "${revision}"
        ;;
    "setup")
        require_root
        "${libexec}"/portzap-setup
        ;;
    *)
        printf "Usage: portzap COMMAND [OPTIONS]\n"
        printf "\n"
        printf "Commands:\n"
        printf "  clone    Clone the hardenedbsd ports tree.\n"
        printf "  pull     Pull updates from the hardenedbsd ports tree.\n"
        printf "  erase    Erase /usr/ports/ and /home/_portzap/ports/.\n"
        printf "  install  Install the ports tree into /usr/ports/.\n"
        printf "  setup    Add the _portzap user, group and home directory.\n"
        ;;
esac
