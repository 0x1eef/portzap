#!/bin/sh

##
# A shell script that takes care of keeping up to date with
# the HardenedBSD ports collection.

source="https://git.hardenedbsd.org/hardenedbsd/ports.git"
stage_dir="/tmp/ports/"

##
# Utils

exit_on_missing_deps() {
    deps="git"
    for dep in $deps; do
        which -s $dep
        if [ $? -ne 0 ]; then
            echo $dep is missing
            exit 1
        fi
    done
}

user_is_root() {
    user_id=$(id -u $(whoami))
    return $user_id = "0"
}

user_is_not_root() {
    user_id=$(id -u $(whoami))
    result=$(test $user_id -ne "0")
    return $result
}

##
# Commands

help() {
    echo "Usage: portzap clone|pull|unpack|rmtree"
}

clone() {
    if user_is_root
    then
        echo "The clone command should not be run as root."
        exit 1
    fi
    if [ -e "$stage_dir/.git" ];
    then
        echo "$stage_dir has already been cloned."
        echo "Run 'portzap pull', or 'portzap rmtree' instead."
        exit 1
    fi
    git clone --depth 1 $source $stage_dir
}

pull() {
    if user_is_root
    then
        echo "The pull command should not be run as root."
        exit 1
    fi
    if [ -e "$stage_dir/.git" ];
    then
       cd $stage_dir
       git pull --rebase origin hardenedbsd/main
    else
        echo "Run 'portzap clone' first."
        exit 1
    fi
}

unpack() {
    if user_is_not_root
    then
        echo "The unpack command should be run as root."
        exit 1
    fi
    cp -Rfv /tmp/ports /usr/
}

rmtree() {
    if [ -e $stage_dir ];
    then
        echo "Please wait."
        rm -rf $stage_dir
        echo "OK: removed $stage_dir"
    else
        echo "$stage_dir does not exist."
        exit 1
    fi
}

case $1 in
    "clone")
        exit_on_missing_deps
        clone
        break
        ;;
    "pull")
        exit_on_missing_deps
        pull
        break
        ;;
    "unpack")
        unpack
        break
        ;;
    "rmtree")
        rmtree
        break
        ;;
    *)
        help
        break
        ;;
esac
