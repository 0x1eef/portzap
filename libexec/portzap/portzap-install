#!/bin/sh -e

##
# variables
gitdir=$1
installdir=$2
revfile=$3
localbase="${LOCALBASE:-/usr/local}"
libexec="${localbase}/libexec/portzap"

##
# functions
perform_update()
{
    rev=$(cat "${revfile}")
    add=$(doas -u _portzap "${libexec}"/git-changed-files "${gitdir}" "${rev}")
    del=$(doas -u _portzap "${libexec}"/git-removed-files "${gitdir}" "${rev}")
    for file in ${del}; do
        target="${installdir}/${file}"
        parent=$(dirname "${target}")
        echo "rm ${target}"
        rm -f "${target}"
        find "${parent}" -type d -maxdepth 0 -empty -delete
    done
    for file in ${add}; do
        target="${installdir}/${file}"
        parent=$(dirname "${target}")
        if [ ! -e "${parent}" ]; then
            run_install "-d" "-m" "u=rwx,g=rwx,o=" "${parent}"
        fi
        run_install "-m" "u=rw,g=rw,o=" "${file}" "${target}"
    done
}

perform_install()
{
    find -s . \
        -maxdepth 1 \
        ! -name "." \
        ! -name ".git" \
        ! -name ".gitignore" \
        ! -name ".hooks" \
        ! -name ".arcconfig" \
        -exec cp -Rpv {} "${installdir}" \;
    set -x
    chown -R root "${installdir}"
}

run_install()
{
    install -o root -g _portzap -v "$@"
}

##
# main
set -x
umask u=rwX,g=rwX,o=
cd "${gitdir}"
set +x
run_install "-d" "${installdir}"
chmod u=rwx,g=rwx,o= "${installdir}"
if [ -e "${revfile}" ]; then
    perform_update
else
    perform_install
fi
doas -u _portzap "${libexec}"/git-rev "${gitdir}" > "${revfile}"
