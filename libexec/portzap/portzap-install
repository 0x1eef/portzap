#!/bin/sh -e

##
# variables
gitdir=$1
installdir=$2
revfile=$3
artifacts=".git .gitignore .hooks .arcconfig"
libexec="/usr/local/libexec/portzap"
mode="u=rwX,g=rwX,o="
flags="-o root -g _portzap -m ${mode} -v"

##
# functions
perform_update()
{
    rev=$(cat "${revfile}")
    add=$(doas -u _portzap ${libexec}/git-changed-files "${gitdir}" "${rev}")
    del=$(doas -u _portzap ${libexec}/git-removed-files "${gitdir}" "${rev}")
    for file in ${del}; do
        target="${installdir}/${file}"
        parent=$(dirname "${target}")
        printf "rm $(rm -vf ${target})"
        if [ -e "${parent}" ]; then
            find "${parent}" -type d -maxdepth 0 -empty -exec rm -vrf {} \;
        fi
    done
    for file in ${add}; do
        target="${installdir}/${file}"
        parent=$(dirname "${target}")
        if [ ! -e "${parent}" ]; then
            install -d ${flags} "${parent}"
        fi
        install ${flags} "${file}" "${target}"
    done
}

perform_install()
{
    find -s . \
        -maxdepth 1 \
        -exec cp -Rfv {} "${installdir}" \; \
        -exec chown -R root:_portzap "${installdir}/{}" \; \
        -exec chmod -R ${mode} "${installdir}/{}" \;
    for path in ${artifacts}; do
        rm -rf "${installdir:?}/${path}"
    done
}

##
# main
cd "${gitdir}"
install -d ${flags} "${installdir}"
if [ -e "${revfile}" ]; then
    perform_update
else
    perform_install
fi
doas -u _portzap ${libexec}/git-rev "${gitdir}" > "${revfile}"
