#!/bin/sh
set -e

#
# globals
#
libexec="$(dirname "${0}")"/..
git="${libexec}"/scripts/git
repodir=$1
installdir=$2
commitfile=$3
force=$4

#
# functions
#
. "${libexec}"/functions/print.sh

#
# main
#
if [ "$(id -u)" != "0" ]; then
    printerr "you must be root"
    exit 1
fi

cd "${repodir}"
sha=$("${git}" rev-parse HEAD)

if [ "${force}" = "-f" ]; then
    # do nothing
else
    if "${libexec}"/scripts/install-check "${sha}" "${commitfile}"; then
        printok "install up to date (add -f to force)"
        exit 0
    fi
fi

mkdir -p "${installdir}"
rsync -av \
      --chown=root:_portzap \
      --delete \
      --delete-excluded \
      --exclude=".git" \
      --exclude=".github" \
      --exclude=".gitignore" \
      --exclude=".gitattributes" \
      --exclude=".git-blame-ignore-revs" \
      --exclude=".cirrus-ci" \
      --exclude=".cirrus.yml" \
      --exclude=".arclint" \
      --exclude=".arcconfig" \
      --exclude=".portzap" \
      "${repodir}/" \
      "${installdir}/"

printf "%s\n" "${sha}" > "${commitfile}"
printok "install complete"
