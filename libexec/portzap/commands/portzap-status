#!/bin/sh
set -e

#
# globals
#
libexec="$(dirname "$0")"/..

#
# functions
#
. "${libexec}"/functions/print.sh

#
# main
#
rule=$("${libexec}"/scripts/get-mdo-rule | tr ';' '\n' | sed '/^$/d')
rules=$(sysctl -n security.mac.do.rules 2> /dev/null || true)
if [ -z "${rules}" ]; then
    printok "disabled"
    exit 1
fi
syslist=$(printf "%s" "${rules}" | tr ';' '\n')
enabled=1
while IFS= read -r entry; do
    if [ -z "${entry}" ]; then
        continue
    fi
    if ! printf "%s\n" "${syslist}" | grep -Fxq -- "${entry}"; then
        enabled=0
        break
    fi
done <<EOFRULES
${rule}
EOFRULES

if [ "${enabled}" -ne 1 ]; then
    printok "disabled"
    exit 1
fi

printok "enabled"
