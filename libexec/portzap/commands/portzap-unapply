#!/bin/sh
set -e

#
# globals
#
libexec="$(dirname "${0}")"/..
user="_portzap"
uid=$(id -u "${user}")
gid=$(pw groupshow "${user}" | awk -F: '{print $3}')

#
# functions
#
. "${libexec}"/functions/print.sh
. "${libexec}"/functions/mdo.sh

filter_rules()
{
    local system_rules portzap_rules
    system_rules=$1
    portzap_rules=$2
    printf "%s" "${system_rules}" | tr ';' '\n' | awk -v rulez="${portzap_rules}" '
BEGIN { n = split(rulez, r, "\n") }
NF {
    for (i = 1; i <= n; i++) if ($0 == r[i]) next
    print
}
'
}

join_rules()
{
    local rule_list
    rule_list=$1
    printf "%s" "${rule_list}" | paste -sd ';' -
}

#
# guards
#
if [ "$(id -u)" != "0" ]; then
    printerr "you must be root"
    exit 1
fi
if [ -z "${uid}" ]; then
    printerr "user ${user} not found"
    exit 1
fi
if [ -z "${gid}" ]; then
    printerr "group ${user} not found"
    exit 1
fi

#
# main
#
portzap_rules=$(get_portzap_rules "${libexec}")
system_rules=$(get_system_rules)
if [ -z "${system_rules}" ]; then
    printok "security.mac.do.rules already empty"
    exit 0
fi
filtered=$(filter_rules "${system_rules}" "${portzap_rules}")
merged=$(join_rules "${filtered}")
if [ "${merged}" = "${system_rules}" ]; then
    printok "security.mac.do.rules unchanged"
    exit 0
fi
sysctl security.mac.do.rules="${merged}"
printok "remove security.mac.do.rules"
