#!/bin/sh -e

##
# variables
localbase=${LOCALBASE:-/usr/local}
libexec=$(dirname "$0")
git="${localbase}"/bin/git
giturl=$1
gitdir=$2
branch=$3
mode="ug=rwX,o="

##
# main
if ! "${libexec}"/isportzap-member; then
    echo "[-] This command must be run by a member of the '_portzap' group"
    exit 1
fi

if [ -e "${gitdir}/.git" ]; then
    echo "[-] ${gitdir} exists."
    echo "[-] Try 'portzap pull'"
    exit 1
fi

set -x
umask ${mode}
doas -u _portzap "${git}" clone "${giturl}" "${gitdir}"
cd "${gitdir}"
set +x
echo "[-] Adjust filemode. This might take a while"
doas -u _portzap "${git}" config core.filemode off
doas -u root /bin/chmod -R ${mode} "${gitdir}"
echo "[-] git checkout ${branch}"
if ! doas -u _portzap "${git}" \
                       checkout -t \
                       origin/"${branch}" \
                       > /dev/null 2>&1; then
    r="${?}"
    echo "[-] 'git checkout' exited with an error"
    exit "${r}"
else
    echo "[-] Done"
fi
